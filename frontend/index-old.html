<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />
    <title>Connect to Wi-Fi</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: 'Inter', Arial, sans-serif;
        background: #181c20;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        color: #ffffff;
        padding: 16px;
      }
      .wrap {
        max-width: 380px;
        width: 100%;
        background: #23272b;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 6px 24px rgba(242, 140, 56, 0.1);
        border: 1px solid #2f343b;
      }
      .logo {
        display: block;
        margin: 0 auto 20px;
        width: 140px;
        height: auto;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 20px;
        color: #f28c38;
        font-weight: 700;
        text-align: center;
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        border-bottom: 1px solid #2f343b;
      }
      .tab {
        padding: 10px 16px;
        background: none;
        border: none;
        color: #a0a6b0;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
      }
      .tab:hover {
        color: #f28c38;
      }
      .tab.active {
        color: #f28c38;
        border-bottom-color: #f28c38;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .list-container {
        min-height: 140px;
        margin: 12px 0;
        position: relative;
      }
      .list {
        max-height: 140px;
        overflow-y: auto;
        padding-right: 6px;
        transition: opacity 0.3s ease;
        display: flex;
        flex-direction: column;
      }
      .list.scanning {
        opacity: 0.6;
        pointer-events: none;
      }
      .list::-webkit-scrollbar {
        width: 4px;
      }
      .list::-webkit-scrollbar-track {
        background: #181c20;
        border-radius: 8px;
      }
      .list::-webkit-scrollbar-thumb {
        background: #f28c38;
        border-radius: 8px;
      }
      .ssid {
        padding: 10px 12px;
        border: 1px solid #2f343b;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        background: #181c20;
        color: #ffffff;
        transition: all 0.2s ease;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .ssid:hover {
        background: #3a2f25;
        border-color: #f28c38;
        transform: translateY(-1px);
      }
      .ssid:active {
        transform: translateY(0);
      }
      .ssid-info {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
      }
      .signal-strength {
        display: flex;
        align-items: center;
        gap: 2px;
        flex-shrink: 0;
      }
      .signal-bar {
        width: 3px;
        background: #a0a6b0;
        border-radius: 1px;
        transition: all 0.2s ease;
      }
      .signal-bar.active {
        background: #f28c38;
      }
      .muted {
        color: #a0a6b0;
        font-size: 13px;
        font-weight: 500;
        text-align: center;
        margin: 8px 0 0 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .ok {
        color: #f28c38;
        font-size: 14px;
        font-weight: 600;
        text-align: center;
        opacity: 0;
        animation: fadeIn 0.5s forwards;
        margin: 8px 0 0 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .err {
        color: #ff4444;
        font-size: 14px;
        font-weight: 600;
        text-align: center;
        white-space: pre-wrap;
        opacity: 0;
        animation: fadeIn 0.5s forwards;
        margin: 8px 0 0 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        line-height: 1.3;
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }
      .password-wrapper {
        position: relative;
        margin-top: 10px;
      }
      input {
        font: inherit;
        padding: 10px 14px;
        width: 100%;
        border-radius: 8px;
        border: 1px solid #2f343b;
        background: #181c20;
        color: #ffffff;
        transition: all 0.2s ease;
        font-size: 14px;
      }
      input::placeholder {
        color: #a0a6b0;
        opacity: 1;
        font-size: 14px;
      }
      input:focus {
        outline: none;
        border-color: #f28c38;
        background: #252a30;
        box-shadow: 0 0 6px rgba(242, 140, 56, 0.2);
      }
      .toggle-password {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #a0a6b0;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .toggle-password svg {
        fill: #a0a6b0;
        transition: fill 0.2s ease;
        width: 100%;
        height: 100%;
      }
      .toggle-password:hover svg {
        fill: #f28c38;
      }
      button.connect {
        font: inherit;
        padding: 12px;
        margin-top: 16px;
        width: 100%;
        border-radius: 8px;
        border: none;
        background: #f28c38;
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-size: 14px;
      }
      button.connect:hover {
        background: #e07b30;
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(242, 140, 56, 0.3);
      }
      button.connect:active {
        transform: translateY(0);
      }
      button.connect:disabled {
        background: #4a4f56;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      button.scan {
        font: inherit;
        padding: 6px 0;
        margin-top: 8px;
        width: auto;
        border: none;
        background: none;
        color: #f28c38;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: all 0.2s ease;
      }
      button.scan:hover {
        text-decoration: underline;
      }
      button.scan svg {
        fill: #f28c38;
        transition: transform 0.2s ease;
        width: 14px;
        height: 14px;
      }
      button.scan.loading svg {
        animation: spin 1s linear infinite;
      }
      button.scan:disabled {
        color: #4a4f56;
        cursor: not-allowed;
      }
      .loader {
        display: none;
        border: 2px solid #ffffff;
        border-top: 2px solid #f28c38;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        flex-shrink: 0;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      button.loading .loader {
        display: block;
      }
      button.loading span {
        visibility: visible;
        opacity: 1;
      }
      .scanning-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(35, 39, 43, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .scanning-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      .empty-state {
        text-align: center;
        color: #a0a6b0;
        padding: 16px;
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 50px;
        font-size: 13px;
        width: 100%;
        height: 100%;
        flex: 1;
      }
      .form-group {
        margin-bottom: 12px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        color: #a0a6b0;
        font-size: 13px;
        font-weight: 500;
      }
      .message-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        flex-shrink: 0;
        font-size: 12px;
      }
      .current-connection {
        background: #1a3a2e;
        border: 1px solid #00bd8f;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .current-connection-info {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
      }
      .current-connection-icon {
        color: #00bd8f;
        font-size: 16px;
        flex-shrink: 0;
      }
      .current-connection-text {
        flex: 1;
      }
      .current-connection-ssid {
        color: #00bd8f;
        font-weight: 600;
        font-size: 14px;
      }
      .current-connection-status {
        color: #a0a6b0;
        font-size: 12px;
        margin-top: 2px;
      }
      .section-title {
        color: #a0a6b0;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 16px 0 8px 0;
      }
      .saved-network {
        padding: 10px 12px;
        border: 1px solid #2f343b;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #181c20;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .saved-network-name {
        color: #ffffff;
        font-size: 14px;
        flex: 1;
      }
      .forget-btn {
        background: none;
        border: none;
        color: #ff4444;
        font-size: 12px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
        font-weight: 500;
      }
      .forget-btn:hover {
        background: rgba(255, 68, 68, 0.1);
      }
      .saved-networks-list {
        max-height: 120px;
        overflow-y: auto;
        padding-right: 6px;
      }
      .saved-networks-list::-webkit-scrollbar {
        width: 4px;
      }
      .saved-networks-list::-webkit-scrollbar-track {
        background: #181c20;
        border-radius: 8px;
      }
      .saved-networks-list::-webkit-scrollbar-thumb {
        background: #f28c38;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <img
        src="public/logo.png"
        alt="Botanika Logo"
        class="logo"
      />
      <h1>Connect to Wi-Fi</h1>

      <!-- Tabs -->
      <div class="tabs">
        <button
          class="tab active"
          onclick="switchTab('wifi')"
        >
          WiFi
        </button>
        <button
          class="tab"
          onclick="switchTab('system')"
        >
          System
        </button>
      </div>

      <!-- WiFi Tab -->
      <div
        id="wifiTab"
        class="tab-content active"
      >
        <div
          id="currentConnection"
          style="display: none"
        ></div>

        <!-- Saved Networks -->
        <div
          id="savedNetworksSection"
          style="display: none"
        >
          <div class="section-title">My Networks</div>
          <div
            id="savedNetworksList"
            class="saved-networks-list"
          ></div>
        </div>

        <div class="form-group">
          <button
            id="scanBtn"
            class="scan"
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M4 12C4 16.4183 7.58172 20 12 20C14.2091 20 16.2091 19.1046 17.6569 17.6569L16.2426 16.2426C15.2116 17.2736 13.6893 18 12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C13.6893 6 15.2116 6.72639 16.2426 7.75736L17.6569 6.34315C16.2091 4.89543 14.2091 4 12 4C7.58172 4 4 7.58172 4 12Z"
                fill="currentColor"
              />
              <path
                d="M18 12C18 9.79086 16.2091 8 14 8V10C15.1046 10 16 10.8954 16 12C16 13.1046 15.1046 14 14 14V16C16.2091 16 18 14.2091 18 12Z"
                fill="currentColor"
              />
            </svg>
            Rescan
          </button>
        </div>

        <div class="list-container">
          <div
            id="ssidList"
            class="list"
          >
            <div class="empty-state">Scanning for Wi-Fi networks...</div>
          </div>
          <div
            id="scanningOverlay"
            class="scanning-overlay"
          >
            <div class="loader"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="ssidInput">Network Name (SSID)</label>
          <input
            id="ssidInput"
            placeholder="Enter SSID"
          />
        </div>

        <div class="form-group">
          <label for="pwdInput">Password</label>
          <div class="password-wrapper">
            <input
              id="pwdInput"
              type="password"
              placeholder="Enter password (if any)"
            />
            <span
              class="toggle-password"
              onclick="togglePassword()"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
                  fill="currentColor"
                  class="eye-open"
                />
                <path
                  d="M12 7C14.76 7 17 9.24 17 12C17 12.65 16.87 13.26 16.64 13.83L19.56 16.75C21.07 15.49 22.26 13.86 22.99 12C21.26 7.61 16.99 4.5 11.99 4.5C10.59 4.5 9.25 4.75 8.01 5.2L10.17 7.36C10.74 7.13 11.35 7 12 7ZM2 4.27L4.28 6.55L4.74 7.01C3.08 8.3 1.78 10.02 1 12C2.73 16.39 7 19.5 12 19.5C13.55 19.5 15.03 19.2 16.38 18.66L16.8 19.08L19.73 22L21 20.73L3.27 3L2 4.27ZM7.53 9.8L9.08 11.35C9.03 11.56 9 11.78 9 12C9 13.66 10.34 15 12 15C12.22 15 12.44 14.97 12.65 14.92L14.2 16.47C13.53 16.8 12.79 17 12 17C9.24 17 7 14.76 7 12C7 11.21 7.2 10.47 7.53 9.8ZM11.84 9.02L14.99 12.17L15.01 12.01C15.01 10.35 13.67 9.01 12.01 9.01L11.84 9.02Z"
                  fill="currentColor"
                  class="eye-closed"
                  style="display: none"
                />
              </svg>
            </span>
          </div>
        </div>

        <button
          id="connectBtn"
          class="connect"
        >
          <span>Connect</span><span class="loader"></span>
        </button>

        <p
          id="result"
          class="muted"
        ></p>
        <p
          id="success"
          class="ok"
        ></p>
        <p id="error"></p>
      </div>
      <!-- End WiFi Tab -->

      <!-- System Tab -->
      <div
        id="systemTab"
        class="tab-content"
      >
        <div class="section-title">Access Point Settings</div>

        <div
          id="apInfo"
          style="margin-bottom: 16px; color: #a0a6b0; font-size: 13px"
        >
          Loading AP info...
        </div>

        <div class="form-group">
          <label for="apPasswordInput">New AP Password</label>
          <div class="password-wrapper">
            <input
              id="apPasswordInput"
              type="password"
              placeholder="Enter new password (8-63 characters)"
            />
            <span
              class="toggle-password"
              onclick="toggleAPPassword()"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
                  fill="currentColor"
                  class="eye-open-ap"
                />
                <path
                  d="M12 7C14.76 7 17 9.24 17 12C17 12.65 16.87 13.26 16.64 13.83L19.56 16.75C21.07 15.49 22.26 13.86 22.99 12C21.26 7.61 16.99 4.5 11.99 4.5C10.59 4.5 9.25 4.75 8.01 5.2L10.17 7.36C10.74 7.13 11.35 7 12 7ZM2 4.27L4.28 6.55L4.74 7.01C3.08 8.3 1.78 10.02 1 12C2.73 16.39 7 19.5 12 19.5C13.55 19.5 15.03 19.2 16.38 18.66L16.8 19.08L19.73 22L21 20.73L3.27 3L2 4.27ZM7.53 9.8L9.08 11.35C9.03 11.56 9 11.78 9 12C9 13.66 10.34 15 12 15C12.22 15 12.44 14.97 12.65 14.92L14.2 16.47C13.53 16.8 12.79 17 12 17C9.24 17 7 14.76 7 12C7 11.21 7.2 10.47 7.53 9.8ZM11.84 9.02L14.99 12.17L15.01 12.01C15.01 10.35 13.67 9.01 12.01 9.01L11.84 9.02Z"
                  fill="currentColor"
                  class="eye-closed-ap"
                  style="display: none"
                />
              </svg>
            </span>
          </div>
        </div>

        <button
          id="changeAPPasswordBtn"
          class="connect"
        >
          <span>Change Password</span><span class="loader"></span>
        </button>

        <p
          id="apResult"
          class="muted"
        ></p>
        <p
          id="apSuccess"
          class="ok"
        ></p>
        <p id="apError"></p>
      </div>
      <!-- End System Tab -->
    </div>

    <script>
      let currentNetworks = []

      function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab').forEach((tab) => tab.classList.remove('active'))
        event.target.classList.add('active')

        // Update tab content
        document.querySelectorAll('.tab-content').forEach((content) => content.classList.remove('active'))

        if (tabName === 'wifi') {
          document.getElementById('wifiTab').classList.add('active')
        } else if (tabName === 'system') {
          document.getElementById('systemTab').classList.add('active')
          loadAPInfo()
        }
      }

      async function loadAPInfo() {
        try {
          let res = await fetch('/api/ap-info')
          let data = await res.json()

          const apInfoEl = document.getElementById('apInfo')

          if (data.ok) {
            apInfoEl.innerHTML = `<strong>Current AP:</strong> ${data.ssid} (${data.interface})`
          } else {
            apInfoEl.innerHTML = 'Failed to load AP info'
          }
        } catch (e) {
          console.error('Failed to load AP info:', e)
          document.getElementById('apInfo').innerHTML = 'Error loading AP info'
        }
      }

      function toggleAPPassword() {
        const pwdInput = document.getElementById('apPasswordInput')
        const eyeOpen = document.querySelector('.eye-open-ap')
        const eyeClosed = document.querySelector('.eye-closed-ap')
        if (pwdInput.type === 'password') {
          pwdInput.type = 'text'
          eyeOpen.style.display = 'none'
          eyeClosed.style.display = 'block'
        } else {
          pwdInput.type = 'password'
          eyeOpen.style.display = 'block'
          eyeClosed.style.display = 'none'
        }
      }

      async function changeAPPassword() {
        const apPasswordInput = document.getElementById('apPasswordInput')
        const changeAPPasswordBtn = document.getElementById('changeAPPasswordBtn')
        const apResultEl = document.getElementById('apResult')
        const apErrorEl = document.getElementById('apError')
        const apSuccessEl = document.getElementById('apSuccess')

        // Clear messages
        apResultEl.innerText = ''
        apErrorEl.innerText = ''
        apSuccessEl.innerText = ''
        apErrorEl.style.animation = 'none'
        apSuccessEl.style.animation = 'none'
        void apErrorEl.offsetWidth
        void apSuccessEl.offsetWidth

        const password = apPasswordInput.value.trim()

        if (!password) {
          apErrorEl.innerHTML = 'Please enter a password'
          apErrorEl.className = 'err'
          apErrorEl.style.animation = 'fadeIn 0.5s forwards'
          return
        }

        if (password.length < 8 || password.length > 63) {
          apErrorEl.innerHTML = 'Password must be 8-63 characters'
          apErrorEl.className = 'err'
          apErrorEl.style.animation = 'fadeIn 0.5s forwards'
          return
        }

        changeAPPasswordBtn.disabled = true
        changeAPPasswordBtn.classList.add('loading')
        changeAPPasswordBtn.querySelector('span').innerText = 'Changing...'

        try {
          let res = await fetch('/api/change-ap-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password }),
          })

          let data = await res.json()

          if (data.ok) {
            apSuccessEl.innerHTML = '✓ AP password changed successfully!'
            apSuccessEl.style.animation = 'fadeIn 0.5s forwards'
            apPasswordInput.value = ''
          } else {
            apErrorEl.innerHTML = data.error || 'Failed to change password'
            apErrorEl.className = 'err'
            apErrorEl.style.animation = 'fadeIn 0.5s forwards'
          }
        } catch (e) {
          apErrorEl.innerHTML = 'Error changing password'
          apErrorEl.className = 'err'
          apErrorEl.style.animation = 'fadeIn 0.5s forwards'
        } finally {
          changeAPPasswordBtn.disabled = false
          changeAPPasswordBtn.classList.remove('loading')
          changeAPPasswordBtn.querySelector('span').innerText = 'Change Password'
        }
      }

      async function loadCurrentConnection() {
        try {
          let res = await fetch('/api/current-connection')
          let data = await res.json()

          const container = document.getElementById('currentConnection')

          if (data.ok && data.connected) {
            const signalIcon = createSignalIcon(data.signal)
            container.innerHTML = `
              <div class="current-connection">
                <div class="current-connection-info">
                  <div class="current-connection-icon">✓</div>
                  <div class="current-connection-text">
                    <div class="current-connection-ssid">${data.ssid}</div>
                    <div class="current-connection-status">Connected</div>
                  </div>
                </div>
                ${signalIcon}
              </div>
            `
            container.style.display = 'block'
          } else {
            container.style.display = 'none'
          }
        } catch (e) {
          console.error('Failed to load current connection:', e)
        }
      }

      async function loadSavedNetworks() {
        try {
          let res = await fetch('/api/saved-networks')
          let data = await res.json()

          const section = document.getElementById('savedNetworksSection')
          const list = document.getElementById('savedNetworksList')

          if (data.ok && data.networks && data.networks.length > 0) {
            list.innerHTML = data.networks
              .map(
                (net) => `
              <div class="saved-network">
                <div class="saved-network-name">${net.ssid}</div>
                <button class="forget-btn" onclick="forgetNetwork('${net.ssid.replace(/'/g, "\\'")}')">Forget</button>
              </div>
            `
              )
              .join('')
            section.style.display = 'block'
          } else {
            section.style.display = 'none'
          }
        } catch (e) {
          console.error('Failed to load saved networks:', e)
        }
      }

      async function forgetNetwork(ssid) {
        if (!confirm(`Forget network "${ssid}"?`)) return

        try {
          let res = await fetch('/api/forget-network', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ssid }),
          })

          let data = await res.json()

          if (data.ok) {
            await loadSavedNetworks()
            await loadCurrentConnection()
          } else {
            alert('Failed to forget network: ' + (data.error || 'Unknown error'))
          }
        } catch (e) {
          alert('Error forgetting network')
        }
      }

      function clearMessages() {
        const errorEl = document.getElementById('error')
        const successEl = document.getElementById('success')
        const resultEl = document.getElementById('result')
        errorEl.innerText = ''
        successEl.innerText = ''
        resultEl.innerText = ''
        errorEl.style.animation = 'none'
        successEl.style.animation = 'none'
        errorEl.className = ''

        void errorEl.offsetWidth
        void successEl.offsetWidth
      }

      function getSignalBars(signal) {
        if (!signal) return 1
        if (signal >= 80) return 4
        if (signal >= 60) return 3
        if (signal >= 40) return 2
        return 1
      }

      function createSignalIcon(signal) {
        const bars = getSignalBars(signal)
        let html = '<div class="signal-strength">'
        for (let i = 0; i < 4; i++) {
          const height = 4 + i * 3
          const isActive = i < bars
          html += `<div class="signal-bar ${isActive ? 'active' : ''}" style="height: ${height}px;"></div>`
        }
        html += '</div>'
        return html
      }

      function removeDuplicateNetworks(networks) {
        const uniqueNetworks = []
        const seenSSIDs = new Set()

        for (const network of networks) {
          if (!seenSSIDs.has(network.ssid)) {
            seenSSIDs.add(network.ssid)
            uniqueNetworks.push(network)
          }
        }

        return uniqueNetworks
      }

      async function scan() {
        clearMessages()
        const scanBtn = document.getElementById('scanBtn')
        const ssidList = document.getElementById('ssidList')
        const scanningOverlay = document.getElementById('scanningOverlay')

        scanBtn.disabled = true
        scanBtn.classList.add('loading')
        ssidList.classList.add('scanning')
        scanningOverlay.classList.add('active')

        try {
          await new Promise((resolve) => setTimeout(resolve, 600))

          let res = await fetch('/api/scan')
          let data = await res.json()

          // Remove duplicate networks before storing
          currentNetworks = removeDuplicateNetworks(data.networks || [])

          let list = ''
          if (currentNetworks.length > 0) {
            for (let n of currentNetworks) {
              const signalIcon = createSignalIcon(n.signal)
              list += `
                <div class="ssid" onclick="selectSSID('${n.ssid.replace(/'/g, "\\'")}')">
                  <div class="ssid-info">
                    <b>${n.ssid}</b>
                  </div>
                  ${signalIcon}
                </div>`
            }
            ssidList.innerHTML = list
          } else {
            ssidList.innerHTML = '<div class="empty-state">No networks found. Try again.</div>'
          }
        } catch (e) {
          console.error('Scan error:', e)
          ssidList.innerHTML = '<div class="empty-state">Unable to scan Wi-Fi networks</div>'
        } finally {
          scanBtn.disabled = false
          scanBtn.classList.remove('loading')
          ssidList.classList.remove('scanning')
          scanningOverlay.classList.remove('active')

          // Refresh connection status after scan
          loadCurrentConnection()
          loadSavedNetworks()
        }
      }

      function selectSSID(ssid) {
        document.getElementById('ssidInput').value = ssid
        document.getElementById('pwdInput').focus()
      }

      function togglePassword() {
        const pwdInput = document.getElementById('pwdInput')
        const eyeOpen = document.querySelector('.eye-open')
        const eyeClosed = document.querySelector('.eye-closed')
        if (pwdInput.type === 'password') {
          pwdInput.type = 'text'
          eyeOpen.style.display = 'none'
          eyeClosed.style.display = 'block'
        } else {
          pwdInput.type = 'password'
          eyeOpen.style.display = 'block'
          eyeClosed.style.display = 'none'
        }
      }

      async function connect() {
        clearMessages()
        const connectBtn = document.getElementById('connectBtn')
        const resultEl = document.getElementById('result')

        const ssid = document.getElementById('ssidInput').value.trim()
        const password = document.getElementById('pwdInput').value.trim()

        if (!ssid) {
          const errorEl = document.getElementById('error')
          errorEl.innerHTML = 'Please enter a network name'
          errorEl.className = 'err'
          errorEl.style.animation = 'fadeIn 0.5s forwards'
          return
        }

        connectBtn.disabled = true
        connectBtn.classList.add('loading')
        connectBtn.querySelector('span').innerText = 'Connecting'

        try {
          let res = await fetch('/api/connect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ssid, password }),
          })

          let data = await res.json()

          if (res.status === 200 && data.ok) {
            window.location.href = '/success.html'
          } else {
            const errorEl = document.getElementById('error')
            const errorMsg = data.error || 'Unable to join this network. Please try again.'
            errorEl.innerHTML = `${errorMsg}`
            errorEl.className = 'err'
            errorEl.style.animation = 'fadeIn 0.5s forwards'
            resultEl.innerText = ''
          }
        } catch (e) {
          const errorEl = document.getElementById('error')
          errorEl.innerHTML = 'Connection failed. Please try again.'
          errorEl.className = 'err'
          errorEl.style.animation = 'fadeIn 0.5s forwards'
          resultEl.innerText = ''
        } finally {
          connectBtn.disabled = false
          connectBtn.classList.remove('loading')
          connectBtn.querySelector('span').innerText = 'Connect'
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('scanBtn').onclick = scan
        document.getElementById('connectBtn').onclick = connect
        document.getElementById('changeAPPasswordBtn').onclick = changeAPPassword

        // Load initial data
        loadCurrentConnection()
        loadSavedNetworks()
        scan()

        document.getElementById('pwdInput').addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            connect()
          }
        })

        document.getElementById('apPasswordInput').addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            changeAPPassword()
          }
        })
      })
    </script>
  </body>
</html>
